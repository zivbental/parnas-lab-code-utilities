# Multiplex Learning Analysis

A comprehensive Python package for analyzing Drosophila learning behavior in multiplex experiments with automatic CS+/CS- detection and statistical analysis.

## Features

- **Automatic CS+ Detection**: Intelligently identifies conditioned stimuli based on experimental protocol (operant vs classical conditioning)
- **Side-Switching Support**: Handles experiments where CS+ odor switches physical sides between phases
- **Flexible Filtering**: Configurable parameters for fly selection criteria
- **Statistical Analysis**: Comprehensive statistical testing with assumption checking
- **Batch Processing**: Analyze entire experiments with multiple trials and genotypes
- **Rich Visualizations**: Generate publication-ready plots and charts

## Installation

1. Clone the repository:
```bash
git clone https://github.com/yourusername/multiplex_v2_analysis.git
cd multiplex_v2_analysis
```

2. Create and activate a virtual environment:
```bash
python -m venv venv
# On Windows:
venv\Scripts\activate
# On macOS/Linux:
source venv/bin/activate
```

3. Install dependencies:
```bash
pip install -r requirements.txt
```

## Quick Start

### Single Trial Analysis

```python
from multiplex_core import MultiplexTrial

# Load and analyze a single trial
trial = MultiplexTrial()
trial.load_data("path/to/fly_loc.csv")
trial.filter_by_num_choices(midline_borders=0.6, threshold=4, filter_phase='both')
results = trial.analyse_time()
```

### Batch Analysis

1. Set up your experiment configuration in `experiment_config.json`:
```json
{
  "description": "Configuration for your experiment",
  "groups": {
    "control": ["control_genotype"],
    "experimental": ["exp_genotype1", "exp_genotype2"]
  },
  "comparisons": [
    {
      "experimental": "exp_genotype1",
      "controls": ["control_genotype"],
      "description": "Experiment 1 vs Control"
    }
  ],
  "analysis_settings": {
    "midline_borders": 0.6,
    "threshold": 4,
    "multiple_testing_correction": "bonferroni",
    "significance_level": 0.05
  }
}
```

2. Configure analysis parameters in `multiplex_v2_analysis.py`:
```python
ANALYSIS_PARAMS = {
    'folder_path': r"path/to/your/experiment/folder",
    'config_path': "experiment_config.json",
    'threshold': 4,                    # Minimum choices required
    'midline_borders': 0.6,           # Midline border threshold
    'filter_phase': 'both'            # Filtering phases
}
```

3. Run the analysis:
```bash
python multiplex_v2_analysis.py
```

## Data Structure

Your experiment folder should be organized as follows:
```
experiment_folder/
├── date_folder_1/
│   ├── trial_1/
│   │   ├── fly_loc.csv
│   │   └── experiment_metadata.json
│   ├── trial_2/
│   │   ├── fly_loc.csv
│   │   └── experiment_metadata.json
│   └── ...
├── date_folder_2/
│   └── ...
└── output/  # Generated by analysis
    ├── plots/
    ├── experiment_data_cleaned.csv
    └── statistical_results.csv
```

### Required Files

- **`fly_loc.csv`**: Contains fly location data with columns:
  - `Timestamp`, `experiment_step`
  - `chamber_X_loc` (fly locations)
  - `chamber_X_shock` (shock data)
  - Odor status columns (`mch_left_status`, `oct_right_status`, etc.)

- **`experiment_metadata.json`**: Contains experiment metadata:
  - `flyGenotype`: Genotype identifier
  - `protocol`: Conditioning protocol (e.g., "protocol_operant.csv")

## Configuration Parameters

### Analysis Parameters

| Parameter | Description | Default | Options |
|-----------|-------------|---------|---------|
| `threshold` | Minimum choices required for valid fly | 4 | Any integer ≥ 0 |
| `midline_borders` | Midline border threshold | 0.6 | 0.0 to 1.0 |
| `filter_phase` | Which phases to filter | 'both' | 'both', 'initial', 'test', 'none' |

### CS+ Detection

The system automatically detects CS+ odors based on experimental protocol:

- **Operant Conditioning**: If MOIL is present, the other active odor is CS+
- **Classical Conditioning**: The odor paired with electrical shock is CS+

## Output Files

### Individual Trial Analysis
- `analysis/fly_loc_learned_index_analysis_TIMESTAMP.csv`: Per-fly results including:
  - `fly_id`, `learned_index`, `cs_plus_odor`
  - `initial_valence_cs_side`, `test_cs_side`, `sides_switched`
  - `initial_valence_cs_preference`, `test_cs_preference`

### Batch Analysis
- `experiment_data_cleaned.csv`: Combined data from all trials
- `statistical_results.csv`: Statistical test results
- `plots/`: Visualization files (PNG format)

## Statistical Analysis

The package performs comprehensive statistical analysis:

1. **Assumption Testing**:
   - Shapiro-Wilk normality test
   - Levene's test for homogeneity of variance

2. **Statistical Tests** (automatically selected):
   - Independent t-test (normal + equal variance)
   - Welch's t-test (normal + unequal variance)
   - Mann-Whitney U test (non-normal)

3. **Multiple Testing Correction**:
   - Bonferroni correction (default)
   - Benjamini-Hochberg FDR

4. **Effect Size Calculation**:
   - Cohen's d (parametric tests)
   - Rank-biserial correlation (non-parametric)

## Examples

### Example 1: Basic Analysis
```python
# Analyze a single trial
trial = MultiplexTrial()
trial.load_data("data/fly_loc.csv")
trial.filter_by_num_choices(0.6, 4, 'both')
results = trial.analyse_time()
print(f"Mean learned index: {results['learned_index'].mean():.2f}")
```

### Example 2: Custom Filtering
```python
# More lenient filtering
trial.filter_by_num_choices(0.5, 2, 'initial')  # Only filter initial phase
results = trial.analyse_time()
```

### Example 3: Batch Analysis with Different Parameters
```python
# In multiplex_v2_analysis.py
ANALYSIS_PARAMS = {
    'folder_path': r"path/to/experiment",
    'threshold': 3,                    # More lenient
    'midline_borders': 0.5,           # Different threshold
    'filter_phase': 'none'            # No filtering
}
```

## Troubleshooting

### Common Issues

1. **"No Learning Shock phase found"**: Ensure your data contains the correct experiment steps
2. **"Missing required files"**: Check that both `fly_loc.csv` and `experiment_metadata.json` exist
3. **"No data collected"**: Verify folder structure and file paths

### Debug Mode

Enable verbose output by modifying the analysis parameters:
```python
# Add debug information
print(f"Processing trial: {trial_folder}")
print(f"CS+ detected: {cs_plus_odor} on {cs_plus_side}")
```

## Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Citation

If you use this software in your research, please cite:

```bibtex
@software{multiplex_learning_analysis,
  title={Multiplex Learning Analysis: A Python package for Drosophila learning behavior analysis},
  author={Your Name},
  year={2024},
  url={https://github.com/yourusername/multiplex_v2_analysis}
}
```

## Support

For questions, issues, or feature requests, please:
- Open an issue on GitHub
- Contact: [your.email@domain.com]

## Acknowledgments

- Built with Python, pandas, matplotlib, seaborn, and scipy
- Designed for Drosophila learning and memory research
- Inspired by classical and operant conditioning paradigms
